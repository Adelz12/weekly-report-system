name: CI — Frontend & Backend

on:
  push:
    branches: [ main, 'dev/**' ]
  pull_request:
    branches: [ main ]

jobs:
  frontend:
    name: Frontend (Node) — install / test / build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests (if present)
        working-directory: frontend
        run: |
          if grep -q "\"test\"" package.json; then
            # react-scripts test normally runs in watch mode; use these flags for CI
            npm test -- --watchAll=false --ci
          else
            echo "No frontend test script configured"
          fi

      - name: Build frontend
        working-directory: frontend
        run: npm run build

  backend:
    name: Backend (Python) — install / lint / tests
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.adminCommand(\"ping\")' >/dev/null 2>&1 || exit 1"
          --health-interval=10s --health-timeout=5s --health-retries=5
    env:
      # The app reads MONGODB_URI from env; point to the service created above
      MONGODB_URI: mongodb://localhost:27017/weekly_reports_ci
      JWT_SECRET: ci-secret-key
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install backend dependencies
        working-directory: backend
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "No requirements.txt found"
          fi

      - name: Run linter (flake8) if configured
        working-directory: backend
        run: |
          if [ -f requirements.txt ] && grep -E "(^|[[:space:]])flake8($|[[:space:]])" requirements.txt; then
            pip install flake8
            flake8 || true
          else
            echo "flake8 not configured in requirements.txt"
          fi

      - name: Run backend tests (pytest) if present
        working-directory: backend
        run: |
          if [ -d tests ] || ( [ -f requirements.txt ] && grep -E "(^|[[:space:]])pytest($|[[:space:]])" requirements.txt ); then
            pip install pytest
            pytest -q
          else
            echo "No backend tests found"
          fi
